<link rel="stylesheet" href="jquery-ui-1.12.1/jquery-ui.css">
<script src="jquery-3.3.1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="jquery-ui-1.12.1/jquery-ui.js"></script>

<style>
    #contenu * {
        padding: 3px;
        margin: 3px;
        resize: none;
        border: none;
        font-family: Arial;
        font-size: 20px;
    }

    .edit, .edit2 {
        position:absolute;
        left:40%;
        top:50%;
        border:1px solid black;
    }

    .add {
        position:absolute;
        left:42%;
        top:55%;
        border:1px solid black;
    }

    #contenu textarea {
        border: 1px solid black;
    }

    #contenu p:hover {
        border-width: 1px;
        border-color: black;
        cursor: pointer;
        border-style: dashed;
    }

    .contenu {
        float: left;
    }

    .croix {
        height: 25px;
        width: 25px;
    }

    .croix:hover {
        cursor: pointer;
    }

    .dragdrop {
        height: 25px;
        width: 25px;
    }

    .dragdrop:hover {
        cursor: pointer;
    }
</style>

<script>
    $(document).ready(function () {
        // Au démarrage de la page, on charge les articles via la requête getA
        var i = 0;
        $.getJSON("data.php?action=getA", function (data) {
            $("#contenu").append('<SELECT name="nom" id="select" size="1"></SELECT>');
            $("#select").append('<OPTION></OPTION>');
            for (i in data.articles) { // Les articles apparaissent dans une liste déroulante
                $("#select").append('<OPTION id="' + data.articles[i].id + '"><div><p class="contenu">' + data.articles[i].name + '</p></div></OPTION>');
            }
        });

        // Initialisation de la variable d'état
        // Cette variable permet de savoir si on est en mode édition ou en mode normal
        // Au démarrage de la page, on est par défaut en mode normal
        var etat = "mode normal";

        // Permettre les modifications de Paragraphes
        $(document).on("click", "#contenu .contenu", function () {
            // fonction appelee lors d'un clic sur un P
            // dans le div de contenu
            var contenu = $(this).html(); // recup contenu
            console.log(etat); // récupère l'état (mode édition ou mode normal)
            if (etat === "mode normal") return; // en mode normal, il est impossible de modifier un P
            var jTa = $("<textarea>")
                .val(contenu)
                .data("contenuInitial", contenu);
            // prépa txtarea
            // AJOUT d'une méta-donnée
            $(this).replaceWith(jTa); // insertion txtarea
            jTa.focus(); // .select();
        });

        // Validation des modifications lorsque l'on appuie sur entrée
        $(document).on("keydown",
            "#contenu textarea",
            function (contexte) {
                // le code ASCII de la touche Enter est 13
                if (contexte.which != 13) return; // Ainsi, si une autre touche qu'entrée est saisie, il ne se passera rien
                if (etat === "mode normal") {
                    $("#contenu textarea").each(function () {
                        // Cas où la personne modifie le P en mode édition, mais avant de valider, il repasse en mode normal
                        // dans ce cas, il faut procéder à une annulation des modifications
                        var contenu = $(this).data("contenuInitial");
                        var jPar = $("<p class='contenu'>").html(contenu); // prépa P
                        $(this).replaceWith(jPar); // insertion P
                    });
                }
                else { // Cas par défaut : modification d'un P en mode édition
                    var contenu = $(this).val(); // recup contenu
                    if (contenu === '') return false; // on vérifie que le contenu n'est pas vide
                    var idRequest = $(this).parent().attr("id"); // attribut parent
                    var jPar = $("<p class='contenu'>").html(contenu); // prépa P
                    $(this).replaceWith(jPar); // insertion P
                    $.getJSON("data.php?action=updateP&id=" + idRequest + "&contenu=" + contenu);
                }
            });

        // Ajout d'un paragraphe
        // Uniquement possible en mode édiion
        $(document).on("click",
            ".add",
            function () {
                // récupération du nombre de paragraphes
                let numItems = $('.contenu').length;
                order = parseInt(numItems) + 1;
                // Récupération du contenu du champ texte
                var contenu = 'Nouveau paragraphe';
                $(this).next().val(""); // puis on le vide
                var Jdiv = $('<div class="ajout"><img src="updown.png" class="dragdrop" /><p class="contenu">' + contenu + '</p><img src="croix.png" class="croix" /></div>');

                // on insère un nouveau P avec ce contenu
                $("#contenu").append(Jdiv);
                $.getJSON("data.php?action=addP&ordre=" + order + "&contenu=" + contenu, function (data) {
                    $(".ajout").attr('id', data.id);
                    var jTa = $("<textarea>")
                        .val(contenu)
                        .data("contenuInitial", contenu);
                    // prépa txtareas
                    // AJOUT d'une méta-donnée
                    $(".ajout .contenu").replaceWith(jTa); // insertion txtarea
                    jTa.focus();
                    $(".ajout").removeClass("ajout");
                    var id_article = $("#select").children(":selected").attr("id"); // id de l'article associé
                    var id_paragraphe = data.id; // id du paragraphe créé
                    // Association du paragraphe et de l'article dans la base articles_paragraphes
                    $.getJSON("data.php?action=addPinA&id_article=" + id_article + "&id_paragraphe=" + id_paragraphe);
                });
            });

        // Modification de paragraphe annulée via la touche Echap (code ASCII : 27)
        $(document).keyup(function (contexte) {
            if (contexte.which != 27) return; // Si la touche saisie est autre qu'échap, il ne se passe rien

            // parcours de tous les textarea
            $("#contenu textarea").each(function () {
                // $(this) dénote le txtarea en cours de parcours
                // permet de récupérer le contenu initial
                var contenu = $(this).data("contenuInitial");
                var jPar = $("<p class='contenu'>").html(contenu); // prépa P
                $(this).replaceWith(jPar); // insertion P
            });

        });

        // Suppression P
        $(document).on("click", ".croix", function () {
            // fonction appelée lors d'un clic sur la croix
            // dans le div de contenu
            if (etat === "mode normal") return; // en mode normal, il est impossible de supprimer un P
            var idRequest = $(this).parent().attr("id"); // attribut parent
            console.log(idRequest);
            $("#" + idRequest).remove(); // On supprime le paragraphe du DOM
            // On supprime le paragraphe de la BDD
            // Le paragraphe sera également supprimé dans la base articles_paragraphes
            $.getJSON("data.php?action=delP&id=" + idRequest);
        });

        // Permettre le drag&drop des paragraphes
        $("#contenu").sortable({
            handle: ".dragdrop",
            start: (event, ui) => {
                ui.item.startPos = ui.item.index();
            },
            update: (event, ui) => {
                // dans ce cas, le drag&drop est possible mais rien n'est enregistré dans la bdd si c'est en mode normal
                // TODO : à améliorer, il faudrait désactiver la possibilité de bouger les P
                if (etat === "mode normal") return; // en mode normal, le drag & drop est désactivé
                let order = ui.item.index();
                $.getJSON("data.php?action=updateOrdre&id=" + ui.item[0].id + "&ordrearrive=" + order + "&ordredepart=" + ui.item.startPos);
            }
        });

        // Fonction pour charger les paragraphes lorsqu'un clic sur un article est réalisé
        $(document).on("change",
            "#select",
            function () {
                $('.parag').remove();
                var id = $("#select").children(":selected").attr("id");
                var i = 0;
                // TODO : lorsqu'un P est créé, il apparait dans toutes les listes de P jusqu'à ce que la page soit actualisée, à corriger
                $.getJSON("data.php?action=getPFromA&article=" + id, function (data) { // Récupération dans la BDD des P associés à un article
                    console.log(data);
                    for (i in data.paragraphes) { // Affichage des tous les P associés à un article
                        $("#contenu").append('<div ordre=' + data.paragraphes[i].ordre + ' id=' + data.paragraphes[i].id + ' class="parag"><img src="updown.png" class="dragdrop" />  <p class="contenu">' + data.paragraphes[i].contenu + '</p><img src="croix.png" class="croix" /></div>');
                    }
                    if (data.paragraphes[0]) {
                        // siginie qu'il y a au moins 1 paragraphe dans l'article, donc que l'article n'est pas nouveau
                        etat = "mode normal"; // permet de situer dans quel état on se trouve
                        $('#contenu').append('<button class="edit">passer en mode edition</button>');
                        $('#contenu').children(".add").remove(); // on enlève le bouton ajouter paragraphe
                    }
                    else {
                        // L'article est nouveau, dans ce cas :
                        // On passe directement en mode édition pour pouvoir ajouter un paragraphe
                        etat = "mode edition"; // permet de situer dans quel état on se trouve
                        $('#contenu').append('<button class="add">ajouter paragraphe</button>'); // on peut ajouter un paragraphe uniquement en mode édition
                        $('#contenu').append('<button class="edit2">revenir au mode normal</button>');
                    }
                });
            });

        // Ajout d'un article
        var jT = $("<input type='text' />");
        var jPlus = $("<input type='button'/>")
            .val("Ajouter article")
            .click(function(){
                // Récupération du contenu du champ texte
                var contenu = $(this).next().val();
                $(this).next().val(""); // puis on le vide
                $.getJSON("data.php?action=addA&name=" + contenu, function (data) {
                    $(".ajout").attr('id', data.id);
                    $("#select").val(contenu).change(); // redirige directement sur l'article en question
                    // ajout du nom de l'article créé dans la liste déroulante,
                    // permet par la suite de pouvoir ajouter un paragraphe sans problèmes (sans actualiser la page)
                    // en effet, pour créer un P, il faut pouvoir avoir l'ID de l'article associé, ce qui est possible dans ce cas
                    $("#select").append('<OPTION id="' + data.id + '" selected><div><p class="contenu">' + contenu + '</p></div></OPTION>');
                });
            });

        // Ces 2 champs apparaissent à tout moment sur la page
        $("#contenu").before(jPlus); // insertion dans le DOM
        jPlus.after(jT); // ajout champ texte après le bouton

        // Mode édition
        $(document).on("click",
            ".edit",
            function () {
                etat = "mode edition"; // permet de situer dans quel état on se trouve
                console.log(etat);
                $('#contenu').append('<button class="add">ajouter paragraphe</button>'); // on peut ajouter un paragraphe uniquement en mode édition
                $('#contenu').append('<button class="edit2">revenir au mode normal</button>');
            });

        // Mode normal
        $(document).on("click",
            ".edit2",
            function () {
                etat = "mode normal"; // permet de situer dans quel état on se trouve
                $('#contenu').append('<button class="edit">passer en mode edition</button>');
                $('#contenu').children(".add").remove(); // on enlève le bouton ajouter paragraphe
                // TODO : Enlever pointillés lors du passage de la souris sur les P (p:hover)
                // Test avec $('#contenu p:hover').css('border-style', 'hidden') mais ne fonctionne pas
            });
    });
</script>

<body>
    <div id="contenu">
    </div>
</body>