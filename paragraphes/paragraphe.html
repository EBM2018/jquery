
<script src="jquery-3.3.1.min.js"></script>
<script src="utils.js"></script>
<script src="ajax.js"></script>
<style>
    #contenu *  {
        padding:3px;
        margin:3px;
        border:none;
        resize:none;
        width:90%;

    }
    #contenu textarea {
        border:1px solid black;
        display: inline-block;
    }
    #contenu p:hover {
        border:1px dashed black;
        cursor:pointer;
    }
    #contenu {color: black;}


    #saisie{border:1px solid grey;
    }
    #suggestions{border:1px solid gray;padding:0px;
        position:absolute;left:30px;right:550px;margin:0px;
        display:none;
    }
    #suggestions li {display:block;padding:5px;}
    #suggestions li:hover{
        cursor:pointer;
        background-color:lightgrey;
    }
    .croix {
        display: inline;
        height: 25px;
        width: 5px;
    }
    .croix:hover {
        cursor:pointer;


    }

</style>
<script>

    var jP= $("<p>").html("Nouveau");


    $(document).ready(function () {
        // on afficher toute les donner de la BBD
        //connexion à la BBD
        $.getJSON("data.php?action=getP", function (data) {
                for (i in data.paragraphes) {
                    $("#contenu").prepend('<div id=' + data.paragraphes[i].id + '><p class="contenu">' + data.paragraphes[i].contenu + '</p><img src=\'croix.png\' class=\'croix\'/></div>');
                }
            });
            // 1) ajouter les éléments d'interaction à la page
            // Leur structure : <+><input text>
            var jT = $("<input type='text' id=\'saisie\' />");
            var jPlus = $("<input type='button'/>")
                .val("+")
                .click(function () {
                    //  gestionnaire d'évnt sur click sur btn +
                    // ici, $(this) dénote le bouton cliqué
                    // $(this).next() dénote donc le champ d'entrée texte
                    // $(this).next().val() est son contenu

                    // Récupération du contenu du champ texte
                    var contenu = $(this).next().val();
                    $(this).next().val(""); // puis on le vide

                    // on insère un nouveau P avec ce contenu
                    var jNextP = jP.clone();
                    if (contenu) jNextP.html(contenu);
                    $("#contenu").prepend(jNextP);
                    console.log("data.php?action=addP&ordre=" + $("#contenu p").length + "&contenu=" + contenu);
                    $.getJSON("data.php?action=addP&ordre=" + $("#contenu p").length + "&contenu=" + contenu);
                });
            //ajouter en appuyant sur entrer
            // A FAIRE
            //

            $("#contenu").before(jPlus); // insertion dans le DOM
            jPlus.after(jT); // ajout champ texte après le bouton
            // 2)  Passage en mode édition des P. insérés
            // clic => le P. se transforme en textarea avec le mm contenu
            // "ENTREE" => le textarea redevient un P. avec le mm contenu

            // Réagir aux clicks sur les P. (y compris futurs !)
            $(document).on("click", "#contenu p", function () {
                // fonction appelee lors d'un clic sur un P
                // dans le div de contenu
                var contenu = $(this).html(); // recup contenu
                var jTa = $("<textarea>")
                    .val(contenu)
                    .data("contenuInitial", contenu);

                // prépa txtarea
                // AJOUT d'une méta-donnée
                $(this).replaceWith(jTa); // insertion txtarea
                jTa.focus(); // .select();
                var img = $("#contenu").append("");

            });

            // Réagir aux appuis sur ENTREE dans les txtarea
            $(document).on("keydown",
                "#contenu textarea",
                function (contexte) {
                    // quelle est la touche appuyée ??
                    // en JQuery, tous les gestionnaires d'evenements
                    // sont destinataires d'un objet event en param.
                    // prop code ascii de la touche : code vaudra "Enter"

                    console.log(contexte.which);
                    if (contexte.which != 13) return;
                    var contenu = $(this).val(); // recup contenu
                    if (contenu === '') return false;
                    var idRequest = $(this).parent().attr("id");
                    var jPar = $("<p class='contenu'>").html(contenu);// prépa P
                    $(this).replaceWith(jPar); // insertion P
                    console.log("data.php?action=updateP?id=" + idRequest + "&contenu=" + contenu);
                    $.getJSON("data.php?action=updateP&id=" + idRequest + "&contenu=" + contenu);

                });


            // 3) "ESC" => toutes les éditions en cours sont annulées
            // les contenus des textarea sont restaurés aux valeurs
            // initiales - elles avaient été stockées par la méthode .data()
            // itérer sur un ensemble : $(sel).each(fonction)

            $(document).keyup(function (contexte) {
                if (contexte.which != 27) return;

                // parcours de tous les textarea
                $("#contenu textarea").each(function () {
                    // $(this) dénote le txtarea en cours de parcours
                    // permet de récupérer le contenu initial
                    var contenu = $(this).data("contenuInitial") ;
                    var jPar = $("<p class='contenu'>").html(contenu); // prépa P
                    $(this).replaceWith(jPar); // insertion P

                });

            });


            // DEBUG
            $(document).on("mouseover", "#contenu *", function () {
                console.log($(this).data());
            });

        });
    // suppression P
    $(document).on("click", ".croix", function () {
        // fonction appelee lors d'un clic sur la croix
        // dans le div de contenu
        var idRequest = $(this).parent().attr("id"); // attribut parent
        console.log(idRequest);
        $("#" + idRequest).remove();
        $.getJSON("data.php?action=delP&id=" + idRequest);
    });


</script>

<body>

<div id="contenu">

    </div>

    </body>